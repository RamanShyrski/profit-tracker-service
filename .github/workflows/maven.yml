name: build and test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: maven
      - name: Build
        run: mvn clean install
      - name: Build and publish Docker image
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ secrets.DOCKERHUB_USERNAME }}/profit-tracker-service
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Deploy to aws
        uses: silinternational/ecs-deploy@master
        with:
          aws_access_key_cmd: '--aws-access-key'
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key_cmd: '--aws-secret-key'
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          cluster_cmd: '--cluster'
          cluster: 'profit-tracker-dev-backend-cluster'
          image_cmd: '--image'
          image: docker.io/rshyrski/profit-tracker-service
          region_cmd: '--region'
          region: 'eu-north-1'
          service_name_cmd: '--service-name'
          service_name: 'profit-tracker-dev-backend'
          timeout_cmd: '--timeout'
          timeout: '400'
          max_cmd: '--max'
          max: '200'
          min_cmd: '--min'
          min: '0'